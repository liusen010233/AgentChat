# 跨地域AI_Agent聊天室产品需求文档 (PRD)


## 产品概述

基于新架构设计的AI智能体聊天室系统，支持多个本机不同的AI智能体通过MCP协议链接聊天室系统，实现ai智能体之间或与用户在同一聊天室内交流，提供简洁的GUI界面。

## 编程要求
- 每个功能模块都有一个对应的文件夹，文件夹中包含该模块的所有代码文件。
- 每个代码文件都有一个对应的类或函数，类或函数的名称尽量与文件名相同。
- 多写注释，注释中包含该类或函数的功能描述、参数说明、返回值说明等。

## 核心功能

### 1. 聊天室的GUI界面基础功能
- **用户建群**: 用户可以手动创建新的聊天群，并设定群名称（必须为英文，30个英文字符以内）、群简介（限制10个中文字或30个英文字符以内）、群公告（可在此本群目的）、群密码。系统自动生成房间号（群聊名称+时间戳+随机码构成），并提供完整的mcp的json设置给到用户（可复制粘贴），方便用户在mcp设置中识别群聊
  - **群聊模式选择**: 用户在建群时先从两种模式中选择（IDE中智能体模式或非IDE环境智能体模式），然后进入群设置界面进行详细配置，后期也可在群设置中更改
- **消息显示**: 气泡式聊天界面，支持Markdown格式显示
  - **气泡布局**: Web端GUI界面中，所有智能体的气泡都在左侧，用户的气泡都在右侧，类似ChatGPT
  - **发送者标识**: 气泡旁边显示智能体名称（不显示智能体ID）或用户名（默认为"user1")
  - **智能体简介查看**: 点击智能体头像可查看其身份介绍
- **消息历史**: 本地存储聊天记录，向上滚动加载更多，每次加载限制为20条
- **群聊历史记录侧边栏**: 在GUI界面左侧显示群聊历史记录，每个记录包含群名称、群简介（小字显示）和群建立时间（小字显示）
- **群聊开关**: 在群聊界面内设置群聊开关，用户可点击控制本群系统是否开启（继续）或暂停（中断）
- **文件消息**: 支持上传和下载，最大支持50MB
- **输入框**: 支持用户参与文本输入和文件上传
- **成员列表**: 显示当前在线智能体成员列表（使用mcp任意功能链接本系统的且时间在20分钟以内的会亮起，超过20分钟未使用mcp链接本系统的会变暗）
- **热更新**: 支持消息和成员列表的热更新，无需重启聊天室系统
- **群设置**: 支持用户配置群聊相关设置，如交互模式、用户参与设置等
  - **用户参与设置**: 用户是否参加群聊的开关（关闭则系统不会询问用户，直接跳过用户）
  - **交互模式切换**: 支持在默认模式（轮询模式）和主持人模式之间切换
  - **超时设置**: 支持修改智能体响应超时多少分钟自动跳过机制（默认为3分钟）
- **@功能实现**: 支持在消息中@特定智能体，触发系统指定智能体工作机制
  - 被@的智能体必须回答，不能选择跳过
  - @后会直接进入下一轮，跳过其他未被询问的智能体
- **导出功能**: 支持导出聊天记录为Markdown或PDF格式


### 2. 本系统核心工具集

> [查看详细的聊天室系统内部记录规则](./聊天室系统内部记录规则.md)
1. **get_context** (wait_for_terminal_input) - 直接获取自上次本智能体消息发布时间后的聊天室后续信息（如有文件消息，会返回文件路径）：
2. **register_agent** - 智能体注册，智能体向系统发送符合要求的注册信息
3. **send_message** - 智能体发送消息到群聊，支持在消息中使用@功能指定其他智能体或用户
   - 当消息中包含@某智能体时，系统会自动解析并在mentions字段中添加被@的智能体名称
   - 系统会根据@机制调整下一个被询问的智能体顺序
4. **search_messages** - 智能体输入关键词，搜索历史消息中包含该关键词的消息
5. **get_full_message** - 智能体输入message_id，获取指定消息的完整内容
6. **skip_response** - 智能体可以使用此工具选择跳过当前回复（仅在can_skip为true时可用）


## 主要技术

### 后端技术栈
- **Python 3.11+**: 主要开发语言
- **FastAPI**: 现代化Web框架，提供高性能API服务
- **Uvicorn**: ASGI服务器，支持异步处理和WebSocket
- **WebSocket**: 实现实时双向通信，支持消息热更新
- **MCP (Model Context Protocol)**: AI智能体通信协议标准
- **FastMCP**: MCP协议的Python实现库
- **Pydantic**: 数据验证和序列化
- **asyncio**: 异步编程支持

### 前端技术栈
- **原生Web技术**: HTML5 + CSS3 + JavaScript ES6+
- **模块化架构**: JavaScript模块化设计，便于维护和扩展
- **WebSocket客户端**: 实现前后端实时通信
- **响应式设计**: 适配不同屏幕尺寸的设备
- **Markdown渲染**: 支持富文本消息显示
- **文件上传处理**: 支持多种文件格式的上传和预览

### 用户界面与体验
- **消息气泡样式**: 智能体消息使用浅色背景，用户消息使用深色背景，区分明显
- **消息通知**: 新消息到达时提供视觉和声音提醒
- **未读消息标记**: 群聊列表中显示未读消息数量
- **输入状态提示**: 显示"正在输入..."状态
- **消息时间戳**: 每条消息显示发送时间
- **移动端适配**: 响应式设计，支持移动设备访问

### 跨平台支持
- **Tauri框架**: 基于Rust的跨平台桌面应用框架
- **Web UI**: 浏览器端界面，支持远程访问
- **桌面应用**: 原生桌面体验，支持Windows、macOS、Linux
- **环境自适应**: 智能检测本地、SSH远程、WSL等环境

### 智能体连接方式
- **IDE中智能体**: 使用MCP协议连接平台，进入终端等待状态，支持一轮对话中多次执行工作
- **非IDE环境智能体**: 在其他云服务器或主机上运行，通过Web消息推送接收系统消息

### 数据存储与管理
- **本地文件存储**: JSON格式存储聊天记录和配置
- **会话管理**: 智能会话生命周期管理
- **资源管理**: 自动清理临时文件和过期数据
- **状态持久化**: 用户设置和群组信息本地保存

### 通信与协议
- **MCP工具集**: 标准化的AI智能体通信接口
- **RESTful API**: 标准HTTP接口设计
- **WebSocket协议**: 实时消息推送和状态同步
- **JSON数据格式**: 统一的数据交换格式
- **错误处理机制**: 完善的异常处理和重连机制

### 安全与性能
- **端口管理**: 智能端口分配和冲突检测
- **CORS配置**: 跨域资源共享安全配置
- **文件大小限制**: 50MB文件上传限制
- **内存监控**: 资源使用监控和优化
- **连接池管理**: WebSocket连接复用和管理
- **超时处理**: 智能体响应超时自动跳过机制
- **错误恢复**: 连接中断后的自动重连和会话恢复

### 开发工具与部署
- **热重载**: 开发环境支持代码热更新
- **调试支持**: 完善的日志系统和调试工具
- **自动化构建**: GitHub Actions CI/CD流水线
- **跨平台打包**: 支持多平台应用打包和分发
- **环境变量配置**: 灵活的配置管理系统

### 智能体交互辅助功能
- **智能体状态指示**: 显示智能体当前状态（在线、离线）
- **智能体简介查看**: 点击智能体名称可查看其详细介绍
- **快捷@功能**: 提供智能体列表快速@选择
- **历史对话导出**: 支持导出聊天记录为Markdown或PDF格式
- **智能体活跃度统计**: 统计各智能体的发言频率和响应时间



============

## 群聊交互模式

### 1. 默认模式（轮询模式）
- 系统向A智能体发指令，使其阅读群公告并发言
- A智能体可以选择发言或回复"跳过"（不发言）
- 发言后，聊天室系统会拿着群公告和A的信息询问B智能体，并明确说明"如果你认为有必要执行工作并回复，就回复内容；否则你可以回复'跳过'"
- 一旦B回复"跳过"则聊天室不显示B的回复
- 系统收到B的回复后，拿着群公告和A和B的发言去询问C智能体
- 依此类推，直到所有群成员全部询问完（包括询问用户）
- 自动开启下一轮询问

### 2. 主持人模式（MVP阶段先不开发，未来再开发）
- 用户在建完群后，第一个进入群聊的为主持人智能体，或者由用户担任主持人
- 主持人智能体可以指定群成员行动

### 3. @指定智能体工作机制
- 在所有模式中，都可以通过"@"触发系统机制指定智能体工作
- 例如在默认模式中，B智能体的消息"@"了D智能体，则系统会直接在B消息后跳过C直接启用D
- 此时系统不再给D"跳过"的选项，并要求D必须回答，哪怕回复"不知道"
- D回答之后就会直接进入下一轮（不再询问E及之后的智能体）
- 主持人模式的指定机制，也是以"@"的形式进行，实际上机制与默认模式相同
- 智能体与智能体、智能体与用户之间可以互相"@"，系统的指定机制仍然有效

### 4. 群聊设置选项
- 用户是否参加群聊的开关（关闭则系统不会询问用户，直接跳过用户）
- 群聊交互模式切换（默认模式、主持人模式等）

============

后续功能点：
1、为单个群内智能体成员设置可不执行项的清单，智能体在群内发送的消息中包含不可执行的项或类似语义项时，智能体可以选择不回应。
