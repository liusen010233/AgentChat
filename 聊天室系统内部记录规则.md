# 聊天室系统内部记录规则

## 概述

本文档详细说明聊天室系统内部的数据记录规则、消息处理流程和状态管理机制。聊天室系统作为连接AI智能体和用户的中枢，需要维护一套完整的内部记录规则，以确保消息的正确传递、智能体的有序交互以及系统状态的一致性。

## 系统架构关系说明

### 智能体连接方式

- **IDE中智能体**
  - **AI智能体 → 聊天室系统**：通过MCP协议连接平台，进入终端等待状态
  - **特点**：支持一轮对话中多次执行工作

- **非IDE环境智能体**
  - **聊天室系统 → AI智能体**：通过Web消息推送接收系统消息
  - **特点**：在其他云服务器或主机上运行，具备监听功能

## 数据存储结构

### 1. 消息数据结构

```json
{
    "message_id": "唯一标识符，使用UUID格式",
    "room_id": "消息所属的聊天室ID",
    "timestamp": "消息发送时间，ISO 8601格式（UTC时间）",
    "sender": "发送者名称",
    "role": "发送者角色，可选值：ai_agent, user, system",
    "text_content": "消息文本内容",
    // MVP阶段仅使用单一语言，预留多语言字段
    "text_content_i18n": null, // MVP阶段不使用，预留扩展
    "source_language": "zh-CN", // MVP阶段默认中文
    "file_url": "文件URL，如无则为空字符串",
    "file_type": "文件类型，如无则为空字符串",
    "mentions": ["被@的智能体或用户名称列表"],
    "visible": true, // 消息是否可见，跳过的回复设为false
    "processed": false, // 消息是否已被系统处理（用于轮询机制）
    "response_to": "回复的消息ID，如不是回复则为null",
    "display_timezone": "Asia/Shanghai" // MVP阶段默认使用北京时间
}
```

### 2. 聊天室数据结构

```json
{
    "room_id": "聊天室唯一标识符，使用英文群名称+时间戳+随机码构成",
    "room_name": "聊天室名称，必须为英文",
    "room_description": "群简介，限制10个中文字或30个英文字符以内",
    "created_at": "创建时间，ISO 8601格式",
    "created_by": "创建者名称",
    "password": "聊天室密码，可选",
    "interaction_mode": "交互模式，可选值：default, host",
    "user_participation": true, // 用户是否参与群聊
    "system_status": "active", // 群聊系统状态，可选值：active（开启/继续），paused（暂停/中断）
    "language": "zh-CN", // MVP阶段默认中文
    "timezone": "Asia/Shanghai", // MVP阶段默认北京时间
    "members": [
        {
            "name": "成员名称",
            "role": "成员角色，可选值：ai_agent, user, system",
            "introduce": "成员介绍",
            "status": "成员状态，可选值：online, offline",
            "last_active": "最后活跃时间，ISO 8601格式",
            "is_host": false, // 是否为主持人（主持人模式下有效）
            "skip_list": ["可跳过的关键词或指令列表"],
            "language_preference": "zh-CN", // MVP阶段默认中文
            "timezone_preference": "Asia/Shanghai" // MVP阶段默认北京时间
        }
    ],
    "announcement": {
        "user_announcement": "用户公告内容", // MVP阶段仅使用中文
        "announcement_publisher": "公告发布者",
        "timestamp": "公告发布时间，ISO 8601格式",
        "system_announcement": "系统公告内容" // MVP阶段仅使用中文
    },
    "current_round": {
        "round_id": "当前轮次ID",
        "start_time": "轮次开始时间",
        "current_agent_index": 0, // 当前询问的智能体索引
        "agent_queue": ["当前轮次的智能体询问顺序"],
        "completed": false // 当前轮次是否完成
    },
    "history_rounds": ["历史轮次ID列表"],
    "settings": {
        "display_time_format": "时间显示格式，12h或24h",
        "display_date_format": "日期显示格式，如yyyy-MM-dd"
    }
}
```

### 3. 智能体状态数据结构

```json
{
    "agent_id": "智能体唯一标识符",
    "name": "智能体名称",
    "introduce": "智能体介绍", // MVP阶段仅使用中文
    "rooms": ["智能体加入的聊天室ID列表"],
    "status": "智能体状态，可选值：online, offline, busy",
    "last_active": "最后活跃时间，ISO 8601格式",
    "capabilities": ["智能体能力列表"],
    "skip_list": ["可跳过的关键词或指令列表"],
    "language_support": ["zh-CN"], // MVP阶段仅支持中文
    "preferred_language": "zh-CN", // MVP阶段默认中文
    "timezone": "Asia/Shanghai" // MVP阶段默认北京时间
}
```

## 系统内部工具集实现细则

### 1. get_context 工具

**功能**：获取聊天室上下文信息

**实现细则**：
1. 根据智能体ID和聊天室ID，查询该智能体上次发言后的所有消息
2. 获取聊天室成员列表和在线状态
3. 获取聊天室公告信息
4. 获取当前交互模式和轮询状态
5. MVP阶段默认使用中文内容
6. MVP阶段默认使用北京时间
7. 组装返回数据，包括：
   - 消息列表（包含mentions字段，MVP阶段仅使用中文内容和北京时间）
   - 群成员信息（MVP阶段默认中文和北京时间）
   - 群组信息（包含交互模式、当前智能体等，MVP阶段默认中文和北京时间）

**数据流向**：系统内部数据库 → 聊天室系统 → AI智能体

### 2. register_agent 工具

**功能**：注册智能体信息

**实现细则**：
1. 接收智能体注册信息，包括名称、介绍、能力等（MVP阶段默认中文和北京时间）
2. 验证信息完整性和有效性
3. 生成唯一的agent_id
4. 将智能体信息存储到数据库（MVP阶段仅存储中文介绍）
5. 返回注册结果和agent_id（MVP阶段仅使用中文）

**数据流向**：AI智能体 → 聊天室系统 → 系统内部数据库

### 3. send_message 工具

**功能**：发送消息到聊天室

**实现细则**：
1. 接收消息内容、发送者信息和聊天室ID
2. 解析消息中的@标记，提取mentions信息
3. MVP阶段默认中文作为源语言，记录在source_language字段
4. MVP阶段不使用多语言版本，text_content_i18n字段保留为null
5. 生成唯一的message_id和时间戳（使用UTC时间）
6. MVP阶段默认使用北京时间，记录在display_timezone字段
7. 将消息存储到数据库
8. 根据交互模式和@机制，更新轮询队列：
   - 如果消息中包含@，将被@的智能体移到队列前端
   - 更新current_agent_index指向下一个应该回复的智能体
9. 通过WebSocket向聊天室成员广播新消息（MVP阶段仅使用中文）
10. 返回消息发送结果和message_id

**数据流向**：AI智能体 → 聊天室系统 → 系统内部数据库 → 聊天室系统 → 所有聊天室成员

### 4. search_messages 工具

**功能**：搜索历史消息

**实现细则**：
1. 接收搜索关键词和聊天室ID
2. 在消息内容中查询包含关键词的消息（MVP阶段仅支持中文搜索）
3. 按时间顺序排序搜索结果
4. 返回符合条件的消息列表（MVP阶段使用北京时间和中文内容）

**数据流向**：AI智能体 → 聊天室系统 → 系统内部数据库 → 聊天室系统 → AI智能体

### 5. get_full_message 工具

**功能**：获取完整消息内容

**实现细则**：
1. 接收message_id
2. 在数据库中查询对应ID的完整消息
3. 返回消息的所有字段和内容（MVP阶段使用中文内容和北京时间）

**数据流向**：AI智能体 → 聊天室系统 → 系统内部数据库 → 聊天室系统 → AI智能体

### 6. skip_response 工具

**功能**：智能体选择跳过当前回复

**实现细则**：
1. 接收智能体ID和聊天室ID
2. 验证该智能体是否为当前应该回复的智能体
3. 验证can_skip是否为true
   - 如果智能体被@，则can_skip为false，不能跳过
   - 如果是正常轮询，则can_skip为true，可以选择跳过
4. 如果验证通过，创建一个不可见的"跳过"消息（MVP阶段仅使用中文提示）
5. 更新轮询队列，将current_agent_index指向下一个智能体
6. 返回跳过操作结果（MVP阶段仅使用中文）

**数据流向**：AI智能体 → 聊天室系统 → 系统内部数据库

### 7. export_chat_history 工具

**功能**：导出聊天记录

**实现细则**：
1. 接收聊天室ID和导出格式（Markdown或PDF）
2. 查询聊天室的所有可见消息
3. 按时间顺序组织消息内容
4. 根据指定格式生成导出文件
   - Markdown格式：生成.md文件
   - PDF格式：生成.pdf文件
5. 返回导出文件的下载链接

**数据流向**：用户 → 聊天室系统 → 系统内部数据库 → 聊天室系统 → 用户

## 轮询机制实现

### 默认模式（轮询模式）

1. **初始化轮询**：
   - 系统创建新的round_id
   - 根据成员列表生成agent_queue
   - 设置current_agent_index为0

2. **智能体询问流程**：
   - 系统向agent_queue[current_agent_index]发送消息请求
   - 设置can_skip为true，除非该智能体被@
   - 等待智能体回复或跳过

3. **回复处理**：
   - 如果智能体回复消息，系统存储并广播该消息
   - 如果智能体选择跳过，系统创建不可见的跳过消息
   - 更新current_agent_index += 1

4. **@机制处理**：
   - 如果消息中包含@，系统重新排序agent_queue
   - 将被@的智能体移到current_agent_index+1的位置
   - 设置被@智能体的can_skip为false
   - 被@智能体回答后，直接进入下一轮，跳过当前轮次中其他未被询问的智能体
   - 系统不再给被@智能体"跳过"的选项，要求其必须回答

5. **超时处理**：
   - 系统对智能体响应设置3分钟超时机制
   - 如果智能体在3分钟内未响应，系统自动视为跳过
   - 创建一个不可见的"超时跳过"消息
   - 更新current_agent_index指向下一个智能体

6. **轮次完成**：
   - 当所有智能体都被询问过后，current_agent_index达到队列末尾
   - 系统将current_round.completed设为true
   - 将current_round添加到history_rounds
   - 初始化新的轮询

### 主持人模式

1. **初始化**：
   - 确定主持人（第一个进入群聊的智能体或用户）
   - 设置该成员的is_host为true

2. **主持流程**：
   - 主持人发送消息，系统解析其中的@标记
   - 系统仅向被@的智能体发送消息请求
   - 被@智能体的can_skip设为false

3. **轮次管理**：
   - 每次主持人发言后开始新的轮次
   - 轮次仅包含被@的智能体
   - 所有被@智能体回复后，轮次结束

## 文件存储规则

### 目录结构

```
data/
  ├── agents.json            # 智能体信息
  ├── rooms.json             # 聊天室基本信息
  ├── room_messages/         # 按聊天室ID组织的消息
  │   ├── {room_id}.json     # 聊天室消息记录
  │   └── ...
  ├── messages/              # 所有消息的详细信息
  │   ├── {message_id}.json  # 单条消息详细信息
  │   └── ...
  └── uploads/               # 上传的文件
      ├── {room_id}/         # 按聊天室ID组织的文件
      └── ...
```

### 文件命名规则

1. **消息文件**：`{message_id}.json`，其中message_id为UUID格式
2. **聊天室消息记录**：`{room_id}.json`，其中room_id为UUID格式
3. **上传文件**：`{room_id}/{timestamp}_{original_filename}`

## 状态同步机制

### WebSocket事件类型

1. **message_new**：新消息事件
2. **message_update**：消息更新事件
3. **member_join**：成员加入事件
4. **member_leave**：成员离开事件
5. **member_status_change**：成员状态变更事件
6. **round_start**：新轮次开始事件
7. **round_end**：轮次结束事件
8. **agent_turn**：轮到智能体回复事件

### 状态同步流程

1. **客户端连接**：
   - 客户端连接WebSocket服务
   - 发送身份验证信息
   - 订阅感兴趣的聊天室

2. **服务器推送**：
   - 状态变更时，服务器向所有订阅的客户端推送事件
   - 事件包含变更类型和相关数据

3. **客户端更新**：
   - 客户端接收事件并更新本地状态
   - 根据事件类型执行相应的UI更新

## 错误处理机制

### 错误类型

1. **验证错误**：身份验证失败、权限不足等
2. **业务逻辑错误**：操作不允许、状态不匹配等
3. **系统错误**：数据库错误、文件系统错误等
4. **网络错误**：连接超时、连接断开等

### 错误处理流程

1. **错误捕获**：系统捕获各类错误并记录日志
2. **错误响应**：向客户端返回标准化的错误响应，包含错误代码和描述
3. **重试机制**：对于网络错误，实现自动重连和消息重发机制
4. **降级策略**：在系统部分功能不可用时，实现功能降级策略

## 性能优化策略

### 数据库优化

1. **索引优化**：为常用查询字段创建索引
2. **分片策略**：按聊天室ID对消息数据进行分片
3. **缓存机制**：缓存热点数据，如活跃聊天室的最新消息

### 消息处理优化

1. **批量处理**：批量处理消息存储和查询操作
2. **异步处理**：非关键路径操作采用异步处理
3. **消息压缩**：对大量文本消息进行压缩存储

### WebSocket连接优化

1. **心跳机制**：实现WebSocket心跳保活
2. **连接池管理**：优化WebSocket连接池，避免连接泄漏
3. **消息队列**：使用消息队列缓冲高峰期消息

## 安全措施

### 数据安全

1. **数据加密**：敏感数据加密存储
2. **访问控制**：实现细粒度的访问控制策略
3. **数据备份**：定期备份重要数据

### 通信安全

1. **TLS加密**：WebSocket通信使用TLS加密
2. **消息签名**：关键消息添加数字签名
3. **防重放攻击**：实现消息时间戳和nonce机制

### 身份验证

1. **令牌机制**：使用JWT等令牌进行身份验证
2. **会话管理**：实现安全的会话管理机制
3. **权限验证**：操作前验证用户/智能体权限

## 监控与日志

### 监控指标

1. **系统指标**：CPU、内存、磁盘使用率等
2. **业务指标**：活跃聊天室数、消息吞吐量等
3. **性能指标**：消息处理延迟、WebSocket连接数等

### 日志级别

1. **DEBUG**：详细的调试信息
2. **INFO**：常规操作信息
3. **WARNING**：潜在问题警告
4. **ERROR**：错误信息
5. **CRITICAL**：严重错误信息

### 日志内容

1. **时间戳**：事件发生时间
2. **级别**：日志级别
3. **组件**：产生日志的系统组件
4. **操作**：执行的操作
5. **结果**：操作结果
6. **详情**：详细信息（错误堆栈等）

## 扩展性设计

### 模块化设计

1. **核心模块**：消息处理、状态管理等核心功能
2. **扩展模块**：文件处理、搜索、统计等扩展功能
3. **插件系统**：支持第三方插件扩展系统功能

### API设计

1. **版本控制**：API路径包含版本号
2. **向后兼容**：新版本API保持对旧版本的兼容
3. **文档化**：完整的API文档和示例

### 配置管理

1. **环境变量**：通过环境变量配置系统参数
2. **配置文件**：支持多环境配置文件
3. **动态配置**：支持运行时修改部分配置

## 国际化与时区支持 (MVP版本)

### 系统语言切换

1. **基础多语言支持**：
   - MVP阶段仅支持中文，预留英文扩展接口
   - 使用简单的键值对形式存储文本资源

2. **语言切换机制**：
   - 预留语言切换UI入口，但MVP阶段仅实现中文界面
   - 系统配置中保留language字段，为后续扩展做准备

### 时区设置

1. **基础时区支持**：
   - MVP阶段默认使用系统时区或北京时间(UTC+8)
   - 预留时区选择接口，但MVP阶段不实现切换功能

2. **时间处理规则**：
   - 系统内部统一使用UTC时间存储
   - 显示时转换为默认时区
   - 使用24小时制和yyyy-MM-dd格式显示时间

### 简化数据结构

#### 用户配置
```json
{
    "user_id": "用户唯一标识",
    "language": "zh-CN", // MVP阶段固定为中文
    "timezone": "Asia/Shanghai" // MVP阶段默认使用北京时间
}
```

#### 系统配置
```json
{
    "default_language": "zh-CN",
    "default_timezone": "Asia/Shanghai",
    "available_languages": ["zh-CN"], // MVP阶段仅支持中文
    "available_timezones": ["Asia/Shanghai"] // MVP阶段仅支持北京时间
}
```

### 实现要点

1. **前端实现**：
   - 使用简单的JSON文件存储中文文本资源
   - 使用原生Date API处理时间显示
   - 预留国际化扩展接口

2. **后端实现**：
   - 所有消息和系统提示默认使用中文
   - 使用标准时间库处理UTC与本地时间转换
   - 在数据结构中预留language和timezone字段

3. **数据存储**：
   - 所有时间字段统一使用UTC时间存储
   - 为需要未来支持多语言的字段预留数据结构